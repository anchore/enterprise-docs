# Define YAML anchors

#var_2: &attach_workspace
#  attach_workspace:
#    at: /home/circleci/workspace/

# Start circleci configuration
version: 2

jobs:
  build:
    docker:
      - image: circleci/golang:1.12-node
    working_directory: ~/build/enterprise-docs/
    steps:
      - checkout
      - run:
          name: Update theme submodule
          command: git submodule update --init --recursive
      - run:
          name: Install s3deploy
          command: |
            mkdir tools
            curl -L https://github.com/bep/s3deploy/releases/download/v2.3.0/s3deploy_2.3.0_Linux-64bit.tar.gz > tools/s3deploy.tar.gz
            pushd tools
            tar -xf ./s3deploy.tar.gz
            chmod +x ./s3deploy
            popd
      - run:
          name: Install Hugo
          command: |
            curl -L https://github.com/gohugoio/hugo/releases/download/v0.55.4/hugo_extended_0.55.4_Linux-64bit.tar.gz > tools/hugo.tar.gz
            pushd tools
            tar -xf ./hugo.tar.gz
            chmod +x ./hugo
            popd
      - run:
          name: Install npms for Docsy Theme
          command: |
            npm install -D postcss-cli autoprefixer
      - run:
          name: Build docs
          command: |
            export PATH=${PATH}:./tools/
            ./build_site.sh ${CIRCLE_BRANCH}
      - run:
          name: Deploy docs to s3
          command: |
            export PATH=${PATH}:./tools/
            ./deploy.sh ${CIRCLE_BRANCH}
workflows:
  version: 2
  default_workflow:
    jobs:
      - build:
          context: aws-prod
          filters:
            branches:
              only:
                - master
